# 統合テスト手順書
## すくすくミントちゃん - 全システム統合テスト

---

## 📋 概要
スマートプランターシステム全体の統合テスト手順書。各機能の連携動作とシステム全体の安定性を確認

## 🎯 テスト目標
- 全機能の正常動作確認
- システム間の連携動作確認
- エラーハンドリングの確認
- パフォーマンステスト
- 長期稼働テスト

---

## 🛠️ テスト環境

### 必要な環境
- Raspberry Pi 5
- 全センサー（AHT25, SEN0193, フロートスイッチ）
- リレーモジュール・水ポンプ
- USBストレージ
- カメラモジュール
- ネットワーク環境

### テスト用植物
- ミント（テスト用）
- プランター・土・水

---

## 🔧 テスト手順

### Phase 1: 個別機能テスト

#### 1.1 センサーシステムテスト
```bash
# テスト実行
cd /home/pi/smart-planter
python test_sensors.py

# 期待される結果
✅ AHT25センサー初期化完了
✅ SEN0193センサー初期化完了
✅ フロートスイッチ初期化完了
✅ 温湿度データ取得: 温度=25.5°C, 湿度=60.0%
✅ 土壌水分データ取得: 45.2%
✅ 水位データ取得: 満水
```

#### 1.2 給水システムテスト
```bash
# テスト実行
python test_watering.py

# 期待される結果
✅ 給水システム状態正常
✅ 手動給水テスト成功
✅ 設定更新テスト成功
✅ 自動給水テスト成功
✅ 給水履歴記録正常
```

#### 1.3 LINE通知テスト
```bash
# テスト実行
python test_line_notify.py

# 期待される結果
✅ 基本メッセージテスト成功
✅ 水やり通知テスト成功
✅ センサーアラートテスト成功
✅ LINE通知送信完了
```

#### 1.4 データ管理テスト
```bash
# テスト実行
python test_data_management.py

# 期待される結果
✅ センサーデータ保存成功
✅ 給水記録保存成功
✅ データ取得成功
✅ ストレージ情報取得成功
✅ バックアップ作成成功
```

### Phase 2: 統合テスト

#### 2.1 システム統合テストスクリプト
```python
# test_integration.py
import time
import logging
import threading
from datetime import datetime
from src.sensors.sensor_manager import SensorManager
from src.watering.auto_watering_manager import AutoWateringManager
from src.notifications.line_notify import LineNotify
from src.data.data_manager_service import DataManagerService
from src.camera.camera_controller import CameraController

# ログ設定
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

class IntegrationTester:
    """統合テストクラス"""
    
    def __init__(self):
        self.logger = logging.getLogger("integration_tester")
        self.test_results = {}
        self.systems = {}
        
    def setup_systems(self):
        """システム初期化"""
        try:
            print("🔧 システム初期化中...")
            
            # データ管理サービス
            self.systems['data_manager'] = DataManagerService()
            self.systems['data_manager'].start_service()
            
            # センサーマネージャー
            self.systems['sensor_manager'] = SensorManager(self.systems['data_manager'])
            
            # LINE通知
            self.systems['line_notify'] = LineNotify()
            
            # 自動給水マネージャー
            self.systems['auto_watering'] = AutoWateringManager(
                self.systems['sensor_manager'], 
                self.systems['line_notify']
            )
            
            # カメラコントローラー
            self.systems['camera'] = CameraController()
            
            print("✅ 全システム初期化完了")
            return True
            
        except Exception as e:
            print(f"❌ システム初期化エラー: {str(e)}")
            return False
    
    def test_sensor_integration(self):
        """センサー統合テスト"""
        print("\n📊 センサー統合テスト開始")
        
        try:
            # センサー監視開始
            self.systems['sensor_manager'].start_monitoring()
            
            # 30秒間データ取得テスト
            for i in range(6):
                time.sleep(5)
                data = self.systems['sensor_manager'].get_latest_data()
                print(f"5秒後: {data}")
                
                # データ保存確認
                if data:
                    self.test_results['sensor_data_save'] = True
            
            self.systems['sensor_manager'].stop_monitoring()
            self.test_results['sensor_integration'] = True
            print("✅ センサー統合テスト完了")
            
        except Exception as e:
            print(f"❌ センサー統合テストエラー: {str(e)}")
            self.test_results['sensor_integration'] = False
    
    def test_watering_integration(self):
        """給水統合テスト"""
        print("\n💧 給水統合テスト開始")
        
        try:
            # 自動給水開始
            self.systems['auto_watering'].start_auto_watering()
            
            # 手動給水テスト
            result = self.systems['auto_watering'].manual_watering()
            print(f"手動給水結果: {result}")
            
            if result['success']:
                self.test_results['manual_watering'] = True
                
                # LINE通知確認
                time.sleep(2)
                self.test_results['watering_notification'] = True
            
            # 給水履歴確認
            history = self.systems['auto_watering'].watering_controller.get_recent_history(1)
            if history:
                self.test_results['watering_history'] = True
            
            self.systems['auto_watering'].stop_auto_watering()
            self.test_results['watering_integration'] = True
            print("✅ 給水統合テスト完了")
            
        except Exception as e:
            print(f"❌ 給水統合テストエラー: {str(e)}")
            self.test_results['watering_integration'] = False
    
    def test_camera_integration(self):
        """カメラ統合テスト"""
        print("\n📸 カメラ統合テスト開始")
        
        try:
            # 撮影テスト
            result = self.systems['camera'].capture_image()
            print(f"撮影結果: {result}")
            
            if result['success']:
                self.test_results['camera_capture'] = True
                
                # 画像保存確認
                if result.get('filepath'):
                    self.test_results['image_save'] = True
            
            self.test_results['camera_integration'] = True
            print("✅ カメラ統合テスト完了")
            
        except Exception as e:
            print(f"❌ カメラ統合テストエラー: {str(e)}")
            self.test_results['camera_integration'] = False
    
    def test_data_flow(self):
        """データフローテスト"""
        print("\n🔄 データフローテスト開始")
        
        try:
            # センサーデータ → データ保存
            sensor_data = self.systems['sensor_manager'].get_latest_data()
            if sensor_data:
                save_result = self.systems['data_manager'].save_sensor_data(sensor_data)
                if save_result:
                    self.test_results['sensor_data_flow'] = True
            
            # 給水記録 → データ保存
            watering_record = {
                'timestamp': datetime.now().isoformat(),
                'soil_moisture': 45.0,
                'duration_seconds': 5,
                'water_amount_ml': 100,
                'success': True
            }
            save_result = self.systems['data_manager'].save_watering_record(watering_record)
            if save_result:
                self.test_results['watering_data_flow'] = True
            
            # データ取得テスト
            sensor_history = self.systems['data_manager'].get_sensor_data(1)
            watering_history = self.systems['data_manager'].get_watering_history(1)
            
            if sensor_history and watering_history:
                self.test_results['data_retrieval'] = True
            
            self.test_results['data_flow'] = True
            print("✅ データフローテスト完了")
            
        except Exception as e:
            print(f"❌ データフローテストエラー: {str(e)}")
            self.test_results['data_flow'] = False
    
    def test_error_handling(self):
        """エラーハンドリングテスト"""
        print("\n⚠️ エラーハンドリングテスト開始")
        
        try:
            # センサーエラーシミュレーション
            # （実際の実装では、センサーを一時的に無効化）
            
            # 給水エラーシミュレーション
            # （水タンク空の状態をシミュレート）
            
            # LINE通知エラーシミュレーション
            # （ネットワーク切断をシミュレート）
            
            self.test_results['error_handling'] = True
            print("✅ エラーハンドリングテスト完了")
            
        except Exception as e:
            print(f"❌ エラーハンドリングテストエラー: {str(e)}")
            self.test_results['error_handling'] = False
    
    def test_performance(self):
        """パフォーマンステスト"""
        print("\n⚡ パフォーマンステスト開始")
        
        try:
            start_time = time.time()
            
            # 大量データ処理テスト
            for i in range(100):
                test_data = {
                    'temperature_humidity': {'temperature': 25.0 + i*0.1, 'humidity': 60.0},
                    'soil_moisture': {'moisture_percentage': 45.0 + i*0.1},
                    'water_level': {'is_water_available': True}
                }
                self.systems['data_manager'].save_sensor_data(test_data)
            
            end_time = time.time()
            processing_time = end_time - start_time
            
            print(f"100件データ処理時間: {processing_time:.2f}秒")
            
            if processing_time < 10:  # 10秒以内
                self.test_results['performance'] = True
            
            print("✅ パフォーマンステスト完了")
            
        except Exception as e:
            print(f"❌ パフォーマンステストエラー: {str(e)}")
            self.test_results['performance'] = False
    
    def cleanup_systems(self):
        """システムクリーンアップ"""
        try:
            print("\n🧹 システムクリーンアップ中...")
            
            if 'auto_watering' in self.systems:
                self.systems['auto_watering'].stop_auto_watering()
            
            if 'sensor_manager' in self.systems:
                self.systems['sensor_manager'].stop_monitoring()
            
            if 'data_manager' in self.systems:
                self.systems['data_manager'].stop_service()
            
            print("✅ システムクリーンアップ完了")
            
        except Exception as e:
            print(f"❌ システムクリーンアップエラー: {str(e)}")
    
    def generate_report(self):
        """テストレポート生成"""
        print("\n📋 テストレポート")
        print("=" * 50)
        
        total_tests = len(self.test_results)
        passed_tests = sum(1 for result in self.test_results.values() if result)
        failed_tests = total_tests - passed_tests
        
        print(f"総テスト数: {total_tests}")
        print(f"成功: {passed_tests}")
        print(f"失敗: {failed_tests}")
        print(f"成功率: {(passed_tests/total_tests)*100:.1f}%")
        
        print("\n詳細結果:")
        for test_name, result in self.test_results.items():
            status = "✅ PASS" if result else "❌ FAIL"
            print(f"  {test_name}: {status}")
        
        # レポートファイル保存
        report_file = f"/mnt/usb-storage/test_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        try:
            with open(report_file, 'w', encoding='utf-8') as f:
                f.write(f"統合テストレポート\n")
                f.write(f"実行日時: {datetime.now().isoformat()}\n")
                f.write(f"総テスト数: {total_tests}\n")
                f.write(f"成功: {passed_tests}\n")
                f.write(f"失敗: {failed_tests}\n")
                f.write(f"成功率: {(passed_tests/total_tests)*100:.1f}%\n\n")
                
                f.write("詳細結果:\n")
                for test_name, result in self.test_results.items():
                    status = "PASS" if result else "FAIL"
                    f.write(f"  {test_name}: {status}\n")
            
            print(f"\n📄 レポート保存: {report_file}")
            
        except Exception as e:
            print(f"❌ レポート保存エラー: {str(e)}")
    
    def run_all_tests(self):
        """全テスト実行"""
        print("🌱 すくすくミントちゃん統合テスト開始")
        print("=" * 50)
        
        # システム初期化
        if not self.setup_systems():
            print("❌ システム初期化失敗")
            return
        
        try:
            # 各テスト実行
            self.test_sensor_integration()
            self.test_watering_integration()
            self.test_camera_integration()
            self.test_data_flow()
            self.test_error_handling()
            self.test_performance()
            
        finally:
            # クリーンアップ
            self.cleanup_systems()
            
            # レポート生成
            self.generate_report()
        
        print("\n🎉 統合テスト完了")

def main():
    """メイン実行"""
    tester = IntegrationTester()
    tester.run_all_tests()

if __name__ == "__main__":
    main()
```

### Phase 3: 長期稼働テスト

#### 3.1 長期稼働テストスクリプト
```python
# test_long_term.py
import time
import logging
from datetime import datetime, timedelta
from src.app import init_systems

def long_term_test():
    """長期稼働テスト（24時間）"""
    print("🕐 長期稼働テスト開始（24時間）")
    
    # システム初期化
    init_systems()
    
    start_time = datetime.now()
    end_time = start_time + timedelta(hours=24)
    
    test_interval = 3600  # 1時間間隔でチェック
    check_count = 0
    
    try:
        while datetime.now() < end_time:
            check_count += 1
            current_time = datetime.now()
            elapsed_hours = (current_time - start_time).total_seconds() / 3600
            
            print(f"\n⏰ チェック {check_count} ({elapsed_hours:.1f}時間経過)")
            
            # システム状態チェック
            # - センサーデータ取得
            # - 給水システム状態
            # - データ保存状況
            # - ストレージ使用量
            # - メモリ使用量
            
            time.sleep(test_interval)
        
        print("✅ 長期稼働テスト完了（24時間）")
        
    except KeyboardInterrupt:
        print("\n⏹️ 長期稼働テスト中断")
    except Exception as e:
        print(f"❌ 長期稼働テストエラー: {str(e)}")
```

### Phase 4: 負荷テスト

#### 4.1 負荷テストスクリプト
```python
# test_load.py
import threading
import time
import random
from src.sensors.sensor_manager import SensorManager
from src.data.data_manager_service import DataManagerService

def load_test():
    """負荷テスト"""
    print("⚡ 負荷テスト開始")
    
    data_service = DataManagerService()
    sensor_manager = SensorManager(data_service)
    
    def sensor_load():
        """センサーデータ負荷"""
        for i in range(1000):
            test_data = {
                'temperature_humidity': {
                    'temperature': 20 + random.random() * 20,
                    'humidity': 30 + random.random() * 50
                },
                'soil_moisture': {
                    'moisture_percentage': random.random() * 100
                },
                'water_level': {
                    'is_water_available': random.choice([True, False])
                }
            }
            data_service.save_sensor_data(test_data)
            time.sleep(0.1)
    
    def watering_load():
        """給水記録負荷"""
        for i in range(100):
            record = {
                'timestamp': datetime.now().isoformat(),
                'soil_moisture': random.random() * 100,
                'duration_seconds': 5,
                'water_amount_ml': 100,
                'success': True
            }
            data_service.save_watering_record(record)
            time.sleep(0.5)
    
    # 並行負荷テスト
    threads = []
    threads.append(threading.Thread(target=sensor_load))
    threads.append(threading.Thread(target=watering_load))
    
    start_time = time.time()
    
    for thread in threads:
        thread.start()
    
    for thread in threads:
        thread.join()
    
    end_time = time.time()
    print(f"✅ 負荷テスト完了: {end_time - start_time:.2f}秒")
```

---

## 📊 テスト実行手順

### 1. 事前準備
```bash
# システム準備
cd /home/pi/smart-planter
sudo systemctl stop smart-planter  # 既存サービス停止

# テスト環境確認
python -c "import RPi.GPIO; print('GPIO利用可能')"
python -c "import smbus2; print('I2C利用可能')"
python -c "import spidev; print('SPI利用可能')"
```

### 2. 個別テスト実行
```bash
# 各機能テスト
python test_sensors.py
python test_watering.py
python test_line_notify.py
python test_data_management.py
```

### 3. 統合テスト実行
```bash
# 統合テスト
python test_integration.py
```

### 4. 長期テスト実行
```bash
# 長期稼働テスト（バックグラウンド実行）
nohup python test_long_term.py > long_term_test.log 2>&1 &

# ログ確認
tail -f long_term_test.log
```

### 5. 負荷テスト実行
```bash
# 負荷テスト
python test_load.py
```

---

## 📋 テスト完了チェックリスト

- [ ] 個別機能テスト完了
- [ ] センサー統合テスト完了
- [ ] 給水統合テスト完了
- [ ] カメラ統合テスト完了
- [ ] データフローテスト完了
- [ ] エラーハンドリングテスト完了
- [ ] パフォーマンステスト完了
- [ ] 長期稼働テスト完了
- [ ] 負荷テスト完了
- [ ] テストレポート生成完了
- [ ] 問題点の修正完了

---

## 🎯 テスト成功基準

### 必須条件
- 全個別機能テストが成功
- 統合テストの成功率が90%以上
- 24時間連続稼働でクラッシュなし
- データ損失なし

### 推奨条件
- 統合テストの成功率が95%以上
- レスポンス時間が仕様内
- メモリリークなし
- ストレージ使用量が適正範囲

---

**作成日**: 2025年1月
**バージョン**: 1.0
**チーム**: KEBABS

