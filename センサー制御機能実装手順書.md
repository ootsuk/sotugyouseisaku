# ã‚»ãƒ³ã‚µãƒ¼åˆ¶å¾¡æ©Ÿèƒ½ è©³ç´°å®Ÿè£…æ‰‹é †æ›¸
## ã™ãã™ããƒŸãƒ³ãƒˆã¡ã‚ƒã‚“ - ã‚»ãƒ³ã‚µãƒ¼åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 

---

## ğŸ“‹ æ¦‚è¦
æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼(AHT25)ã¨åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼(SEN0193)ã®åˆ¶å¾¡æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®è©³ç´°æ‰‹é †æ›¸

## ğŸ¯ å®Ÿè£…ç›®æ¨™
- AHT25æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ã®I2Cé€šä¿¡åˆ¶å¾¡
- SEN0193åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ã®ADCåˆ¶å¾¡
- ã‚»ãƒ³ã‚µãƒ¼å€¤ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨æ•…éšœæ™‚å¯¾å¿œ
- ãƒ‡ãƒ¼ã‚¿å–å¾—ã®å®šæœŸå®Ÿè¡Œ

---

## ğŸ› ï¸ å¿…è¦ãªç’°å¢ƒ

### ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢
- Raspberry Pi 5
- æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ AHT25
- åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ SEN0193
- ADC MCP3002
- ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼ãƒ¯ã‚¤ãƒ¤ãƒ¼
- ãƒ–ãƒ¬ãƒƒãƒ‰ãƒœãƒ¼ãƒ‰

### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
- Python 3.11.x
- RPi.GPIO
- smbus2 (I2Cé€šä¿¡ç”¨)
- spidev (SPIé€šä¿¡ç”¨)
- numpy (ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨)

---

## ğŸ”§ å®Ÿè£…æ‰‹é †

### Step 1: ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ¥ç¶š

#### 1.1 GPIOãƒ”ãƒ³é…ç½®
```python
# GPIOãƒ”ãƒ³å®šç¾©
GPIO_PINS = {
    # I2Cé€šä¿¡ (AHT25æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼)
    'I2C_SDA': 2,  # GPIO 2 (Pin 3)
    'I2C_SCL': 3,  # GPIO 3 (Pin 5)
    
    # SPIé€šä¿¡ (MCP3002 ADC)
    'SPI_MOSI': 10,  # GPIO 10 (Pin 19)
    'SPI_MISO': 9,   # GPIO 9 (Pin 21)
    'SPI_SCLK': 11,  # GPIO 11 (Pin 23)
    'SPI_CE0': 8,    # GPIO 8 (Pin 24)
    
    # ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒ
    'FLOAT_SWITCH': 18,  # GPIO 18 (Pin 12)
    
    # ãƒªãƒ¬ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (æ°´ãƒãƒ³ãƒ—åˆ¶å¾¡)
    'RELAY_PUMP': 16,    # GPIO 16 (Pin 36)
}
```

#### 1.2 é…ç·šå›³
```
AHT25æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼:
- VCC â†’ 3.3V (Pin 1)
- GND â†’ GND (Pin 6)
- SDA â†’ GPIO 2 (Pin 3)
- SCL â†’ GPIO 3 (Pin 5)

SEN0193åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼:
- VCC â†’ 5V (Pin 2)
- GND â†’ GND (Pin 6)
- SIG â†’ MCP3002 CH0

MCP3002 ADC:
- VDD â†’ 3.3V (Pin 1)
- VREF â†’ 3.3V (Pin 1)
- AGND â†’ GND (Pin 6)
- DGND â†’ GND (Pin 6)
- CLK â†’ GPIO 11 (Pin 23)
- DOUT â†’ GPIO 9 (Pin 21)
- DIN â†’ GPIO 10 (Pin 19)
- CS/SHDN â†’ GPIO 8 (Pin 24)
```

### Step 2: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š

#### 2.1 I2Cãƒ»SPIæœ‰åŠ¹åŒ–
```bash
# Raspberry Piè¨­å®š
sudo raspi-config

# é¸æŠé …ç›®:
# 3 Interface Options
#   P4 I2C â†’ Enable
#   P5 SPI â†’ Enable

# å†èµ·å‹•
sudo reboot
```

#### 2.2 å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
# Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install RPi.GPIO
pip install smbus2
pip install spidev
pip install numpy
```

### Step 3: ã‚»ãƒ³ã‚µãƒ¼åˆ¶å¾¡ã‚¯ãƒ©ã‚¹å®Ÿè£…

#### 3.1 åŸºæœ¬ã‚»ãƒ³ã‚µãƒ¼ã‚¯ãƒ©ã‚¹
```python
# src/sensors/base_sensor.py
import time
import logging
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional

class BaseSensor(ABC):
    """ã‚»ãƒ³ã‚µãƒ¼ã®åŸºåº•ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, name: str, pin: int):
        self.name = name
        self.pin = pin
        self.error_count = 0
        self.max_errors = 3
        self.is_enabled = True
        self.logger = logging.getLogger(f"sensor.{name}")
        
    @abstractmethod
    def read_data(self) -> Dict[str, Any]:
        """ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹"""
        pass
    
    @abstractmethod
    def initialize(self) -> bool:
        """ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹"""
        pass
    
    def is_healthy(self) -> bool:
        """ã‚»ãƒ³ã‚µãƒ¼ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯"""
        return self.error_count < self.max_errors and self.is_enabled
    
    def reset_error_count(self):
        """ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ"""
        self.error_count = 0
    
    def increment_error_count(self):
        """ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—åŠ """
        self.error_count += 1
        if self.error_count >= self.max_errors:
            self.logger.error(f"{self.name} ã‚»ãƒ³ã‚µãƒ¼ãŒæ•…éšœçŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸ")
            self.is_enabled = False
```

#### 3.2 AHT25æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ã‚¯ãƒ©ã‚¹
```python
# src/sensors/aht25_sensor.py
import smbus2
import time
from typing import Dict, Any
from .base_sensor import BaseSensor

class AHT25Sensor(BaseSensor):
    """AHT25æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼åˆ¶å¾¡ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        super().__init__("AHT25", 0)
        self.bus = smbus2.SMBus(1)  # I2C bus 1
        self.address = 0x38  # AHT25ã®I2Cã‚¢ãƒ‰ãƒ¬ã‚¹
        self.initialized = False
        
    def initialize(self) -> bool:
        """AHT25ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆæœŸåŒ–"""
        try:
            # ã‚»ãƒ³ã‚µãƒ¼ãƒªã‚»ãƒƒãƒˆ
            self.bus.write_byte(self.address, 0xBA)
            time.sleep(0.1)
            
            # åˆæœŸåŒ–ã‚³ãƒãƒ³ãƒ‰
            self.bus.write_byte(self.address, 0xBE)
            self.bus.write_byte(self.address, 0x08)
            self.bus.write_byte(self.address, 0x00)
            time.sleep(0.1)
            
            self.initialized = True
            self.logger.info("AHT25ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–å®Œäº†")
            return True
            
        except Exception as e:
            self.logger.error(f"AHT25åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.increment_error_count()
            return False
    
    def read_data(self) -> Dict[str, Any]:
        """æ¸©æ¹¿åº¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹"""
        if not self.initialized:
            if not self.initialize():
                return {"error": "åˆæœŸåŒ–å¤±æ•—"}
        
        try:
            # æ¸¬å®šé–‹å§‹ã‚³ãƒãƒ³ãƒ‰
            self.bus.write_byte(self.address, 0xAC)
            self.bus.write_byte(self.address, 0x33)
            self.bus.write_byte(self.address, 0x00)
            
            # æ¸¬å®šå®Œäº†å¾…æ©Ÿ
            time.sleep(0.1)
            
            # ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š
            data = self.bus.read_i2c_block_data(self.address, 0x00, 6)
            
            # ãƒ‡ãƒ¼ã‚¿è§£æ
            humidity_raw = (data[1] << 12) | (data[2] << 4) | (data[3] >> 4)
            temperature_raw = ((data[3] & 0x0F) << 16) | (data[4] << 8) | data[5]
            
            # å€¤ã«å¤‰æ›
            humidity = (humidity_raw / 0x100000) * 100
            temperature = (temperature_raw / 0x100000) * 200 - 50
            
            # å€¤ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            if not (0 <= humidity <= 100) or not (-40 <= temperature <= 85):
                raise ValueError("ã‚»ãƒ³ã‚µãƒ¼å€¤ãŒç¯„å›²å¤–ã§ã™")
            
            self.reset_error_count()
            return {
                "temperature": round(temperature, 1),
                "humidity": round(humidity, 1),
                "timestamp": time.time()
            }
            
        except Exception as e:
            self.logger.error(f"AHT25èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.increment_error_count()
            return {"error": str(e)}
    
    def get_status(self) -> Dict[str, Any]:
        """ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹ã‚’å–å¾—"""
        return {
            "name": self.name,
            "enabled": self.is_enabled,
            "error_count": self.error_count,
            "healthy": self.is_healthy(),
            "initialized": self.initialized
        }
```

#### 3.3 SEN0193åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ã‚¯ãƒ©ã‚¹
```python
# src/sensors/sen0193_sensor.py
import spidev
import time
import numpy as np
from typing import Dict, Any, List
from .base_sensor import BaseSensor

class SEN0193Sensor(BaseSensor):
    """SEN0193åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼åˆ¶å¾¡ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        super().__init__("SEN0193", 0)
        self.spi = spidev.SpiDev()
        self.spi.open(0, 0)  # SPI bus 0, device 0
        self.spi.max_speed_hz = 1000000  # 1MHz
        self.channel = 0  # MCP3002 CH0
        self.reading_history = []
        self.max_history = 10
        
    def initialize(self) -> bool:
        """SEN0193ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆæœŸåŒ–"""
        try:
            # SPIé€šä¿¡ãƒ†ã‚¹ãƒˆ
            test_data = self._read_adc(self.channel)
            if test_data is None:
                raise Exception("SPIé€šä¿¡ãƒ†ã‚¹ãƒˆå¤±æ•—")
            
            self.logger.info("SEN0193ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–å®Œäº†")
            return True
            
        except Exception as e:
            self.logger.error(f"SEN0193åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.increment_error_count()
            return False
    
    def _read_adc(self, channel: int) -> Optional[int]:
        """ADCã‹ã‚‰å€¤ã‚’èª­ã¿å–ã‚‹"""
        try:
            # MCP3002ç”¨ã®SPIé€šä¿¡
            adc = self.spi.xfer2([1, (8 + channel) << 4, 0])
            data = ((adc[1] & 3) << 8) + adc[2]
            return data
        except Exception as e:
            self.logger.error(f"ADCèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {str(e)}")
            return None
    
    def read_data(self) -> Dict[str, Any]:
        """åœŸå£Œæ°´åˆ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹"""
        try:
            # è¤‡æ•°å›èª­ã¿å–ã‚Šã§ãƒã‚¤ã‚ºé™¤å»
            readings = []
            for _ in range(5):
                value = self._read_adc(self.channel)
                if value is not None:
                    readings.append(value)
                time.sleep(0.01)
            
            if not readings:
                raise Exception("ADCèª­ã¿å–ã‚Šå¤±æ•—")
            
            # å¹³å‡å€¤è¨ˆç®—
            raw_value = np.mean(readings)
            
            # å±¥æ­´ã«è¿½åŠ 
            self.reading_history.append(raw_value)
            if len(self.reading_history) > self.max_history:
                self.reading_history.pop(0)
            
            # ç§»å‹•å¹³å‡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            filtered_value = np.mean(self.reading_history)
            
            # åœŸå£Œæ°´åˆ†ç‡ã«å¤‰æ› (0-1023 â†’ 0-100%)
            moisture_percentage = (filtered_value / 1023) * 100
            
            # å€¤ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            if not (0 <= moisture_percentage <= 100):
                raise ValueError("åœŸå£Œæ°´åˆ†å€¤ãŒç¯„å›²å¤–ã§ã™")
            
            self.reset_error_count()
            return {
                "raw_value": int(raw_value),
                "filtered_value": int(filtered_value),
                "moisture_percentage": round(moisture_percentage, 1),
                "timestamp": time.time()
            }
            
        except Exception as e:
            self.logger.error(f"SEN0193èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.increment_error_count()
            return {"error": str(e)}
    
    def get_status(self) -> Dict[str, Any]:
        """ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹ã‚’å–å¾—"""
        return {
            "name": self.name,
            "enabled": self.is_enabled,
            "error_count": self.error_count,
            "healthy": self.is_healthy(),
            "reading_history_length": len(self.reading_history)
        }
```

#### 3.4 ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒã‚¯ãƒ©ã‚¹
```python
# src/sensors/float_switch.py
import RPi.GPIO as GPIO
import time
from typing import Dict, Any
from .base_sensor import BaseSensor

class FloatSwitch(BaseSensor):
    """ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒåˆ¶å¾¡ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, pin: int = 18):
        super().__init__("FloatSwitch", pin)
        GPIO.setmode(GPIO.BCM)
        GPIO.setup(pin, GPIO.IN, pull_up_down=GPIO.PUD_UP)
        
    def initialize(self) -> bool:
        """ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒã‚’åˆæœŸåŒ–"""
        try:
            # åˆæœŸçŠ¶æ…‹ç¢ºèª
            initial_state = self.read_data()
            self.logger.info(f"ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒåˆæœŸåŒ–å®Œäº†: {initial_state}")
            return True
        except Exception as e:
            self.logger.error(f"ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.increment_error_count()
            return False
    
    def read_data(self) -> Dict[str, Any]:
        """ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒã®çŠ¶æ…‹ã‚’èª­ã¿å–ã‚‹"""
        try:
            # ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
            readings = []
            for _ in range(5):
                readings.append(GPIO.input(self.pin))
                time.sleep(0.01)
            
            # å¤šæ•°æ±ºã§çŠ¶æ…‹æ±ºå®š
            state = 1 if sum(readings) >= 3 else 0
            is_water_available = bool(state)
            
            self.reset_error_count()
            return {
                "is_water_available": is_water_available,
                "raw_state": state,
                "timestamp": time.time()
            }
            
        except Exception as e:
            self.logger.error(f"ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {str(e)}")
            self.increment_error_count()
            return {"error": str(e)}
    
    def get_status(self) -> Dict[str, Any]:
        """ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹ã‚’å–å¾—"""
        return {
            "name": self.name,
            "enabled": self.is_enabled,
            "error_count": self.error_count,
            "healthy": self.is_healthy(),
            "pin": self.pin
        }
```

### Step 4: ã‚»ãƒ³ã‚µãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¯ãƒ©ã‚¹

#### 4.1 ã‚»ãƒ³ã‚µãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
```python
# src/sensors/sensor_manager.py
import threading
import time
import logging
from typing import Dict, Any, List
from .aht25_sensor import AHT25Sensor
from .sen0193_sensor import SEN0193Sensor
from .float_switch import FloatSwitch

class SensorManager:
    """ã‚»ãƒ³ã‚µãƒ¼ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        self.logger = logging.getLogger("sensor_manager")
        self.sensors = {}
        self.data_cache = {}
        self.running = False
        self.threads = {}
        
        # ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–
        self._initialize_sensors()
        
    def _initialize_sensors(self):
        """ã‚»ãƒ³ã‚µãƒ¼ã‚’åˆæœŸåŒ–"""
        try:
            # æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼
            self.sensors['temperature_humidity'] = AHT25Sensor()
            
            # åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼
            self.sensors['soil_moisture'] = SEN0193Sensor()
            
            # ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒ
            self.sensors['water_level'] = FloatSwitch()
            
            self.logger.info("å…¨ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–å®Œäº†")
            
        except Exception as e:
            self.logger.error(f"ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    def start_monitoring(self):
        """ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–é–‹å§‹"""
        self.running = True
        
        # æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ç›£è¦– (30åˆ†é–“éš”)
        self.threads['temperature_humidity'] = threading.Thread(
            target=self._monitor_temperature_humidity,
            daemon=True
        )
        self.threads['temperature_humidity'].start()
        
        # åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ç›£è¦– (5åˆ†é–“éš”)
        self.threads['soil_moisture'] = threading.Thread(
            target=self._monitor_soil_moisture,
            daemon=True
        )
        self.threads['soil_moisture'].start()
        
        # ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒç›£è¦– (1åˆ†é–“éš”)
        self.threads['water_level'] = threading.Thread(
            target=self._monitor_water_level,
            daemon=True
        )
        self.threads['water_level'].start()
        
        self.logger.info("ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–é–‹å§‹")
    
    def stop_monitoring(self):
        """ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–åœæ­¢"""
        self.running = False
        self.logger.info("ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–åœæ­¢")
    
    def _monitor_temperature_humidity(self):
        """æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–"""
        while self.running:
            try:
                data = self.sensors['temperature_humidity'].read_data()
                if 'error' not in data:
                    self.data_cache['temperature_humidity'] = data
                    self.logger.debug(f"æ¸©æ¹¿åº¦ãƒ‡ãƒ¼ã‚¿æ›´æ–°: {data}")
                else:
                    self.logger.error(f"æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼: {data['error']}")
                
                time.sleep(1800)  # 30åˆ†å¾…æ©Ÿ
                
            except Exception as e:
                self.logger.error(f"æ¸©æ¹¿åº¦ç›£è¦–ã‚¨ãƒ©ãƒ¼: {str(e)}")
                time.sleep(60)  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯1åˆ†å¾…æ©Ÿ
    
    def _monitor_soil_moisture(self):
        """åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ç›£è¦–"""
        while self.running:
            try:
                data = self.sensors['soil_moisture'].read_data()
                if 'error' not in data:
                    self.data_cache['soil_moisture'] = data
                    self.logger.debug(f"åœŸå£Œæ°´åˆ†ãƒ‡ãƒ¼ã‚¿æ›´æ–°: {data}")
                else:
                    self.logger.error(f"åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼: {data['error']}")
                
                time.sleep(300)  # 5åˆ†å¾…æ©Ÿ
                
            except Exception as e:
                self.logger.error(f"åœŸå£Œæ°´åˆ†ç›£è¦–ã‚¨ãƒ©ãƒ¼: {str(e)}")
                time.sleep(60)  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯1åˆ†å¾…æ©Ÿ
    
    def _monitor_water_level(self):
        """ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒç›£è¦–"""
        while self.running:
            try:
                data = self.sensors['water_level'].read_data()
                if 'error' not in data:
                    self.data_cache['water_level'] = data
                    self.logger.debug(f"æ°´ä½ãƒ‡ãƒ¼ã‚¿æ›´æ–°: {data}")
                else:
                    self.logger.error(f"ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒã‚¨ãƒ©ãƒ¼: {data['error']}")
                
                time.sleep(60)  # 1åˆ†å¾…æ©Ÿ
                
            except Exception as e:
                self.logger.error(f"æ°´ä½ç›£è¦–ã‚¨ãƒ©ãƒ¼: {str(e)}")
                time.sleep(30)  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯30ç§’å¾…æ©Ÿ
    
    def get_latest_data(self, sensor_name: str = None) -> Dict[str, Any]:
        """æœ€æ–°ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
        if sensor_name:
            return self.data_cache.get(sensor_name, {})
        return self.data_cache.copy()
    
    def get_sensor_status(self) -> Dict[str, Any]:
        """å…¨ã‚»ãƒ³ã‚µãƒ¼ã®çŠ¶æ…‹ã‚’å–å¾—"""
        status = {}
        for name, sensor in self.sensors.items():
            status[name] = sensor.get_status()
        return status
    
    def force_read(self, sensor_name: str) -> Dict[str, Any]:
        """æŒ‡å®šã‚»ãƒ³ã‚µãƒ¼ã®å¼·åˆ¶èª­ã¿å–ã‚Š"""
        if sensor_name in self.sensors:
            return self.sensors[sensor_name].read_data()
        return {"error": "ã‚»ãƒ³ã‚µãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"}
```

### Step 5: ãƒ†ã‚¹ãƒˆå®Ÿè£…

#### 5.1 ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```python
# test_sensors.py
import time
import logging
from src.sensors.sensor_manager import SensorManager

# ãƒ­ã‚°è¨­å®š
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

def test_sensors():
    """ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    print("ğŸŒ± ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹")
    
    # ã‚»ãƒ³ã‚µãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
    sensor_manager = SensorManager()
    
    # å€‹åˆ¥ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ
    print("\nğŸ“Š å€‹åˆ¥ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ")
    
    # æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ
    print("ğŸŒ¡ï¸ æ¸©æ¹¿åº¦ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ...")
    temp_humidity_data = sensor_manager.force_read('temperature_humidity')
    print(f"çµæœ: {temp_humidity_data}")
    
    # åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ
    print("ğŸ’§ åœŸå£Œæ°´åˆ†ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆ...")
    soil_moisture_data = sensor_manager.force_read('soil_moisture')
    print(f"çµæœ: {soil_moisture_data}")
    
    # ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒãƒ†ã‚¹ãƒˆ
    print("ğŸš° ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒãƒ†ã‚¹ãƒˆ...")
    water_level_data = sensor_manager.force_read('water_level')
    print(f"çµæœ: {water_level_data}")
    
    # ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹ç¢ºèª
    print("\nğŸ“‹ ã‚»ãƒ³ã‚µãƒ¼çŠ¶æ…‹")
    status = sensor_manager.get_sensor_status()
    for name, sensor_status in status.items():
        print(f"{name}: {sensor_status}")
    
    # ç›£è¦–ãƒ†ã‚¹ãƒˆ (30ç§’é–“)
    print("\nğŸ”„ ç›£è¦–ãƒ†ã‚¹ãƒˆ (30ç§’é–“)")
    sensor_manager.start_monitoring()
    
    for i in range(6):
        time.sleep(5)
        latest_data = sensor_manager.get_latest_data()
        print(f"5ç§’å¾Œ: {latest_data}")
    
    sensor_manager.stop_monitoring()
    print("âœ… ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆå®Œäº†")

if __name__ == "__main__":
    test_sensors()
```

### Step 6: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### 6.1 ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

**I2Cé€šä¿¡ã‚¨ãƒ©ãƒ¼:**
```bash
# I2Cãƒ‡ãƒã‚¤ã‚¹ç¢ºèª
sudo i2cdetect -y 1

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: 0x38 (AHT25ã®ã‚¢ãƒ‰ãƒ¬ã‚¹)
```

**SPIé€šä¿¡ã‚¨ãƒ©ãƒ¼:**
```bash
# SPIãƒ‡ãƒã‚¤ã‚¹ç¢ºèª
ls /dev/spi*

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: /dev/spidev0.0
```

**GPIOæ¨©é™ã‚¨ãƒ©ãƒ¼:**
```bash
# GPIOã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
sudo usermod -a -G gpio pi

# å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦
```

#### 6.2 ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰
```bash
# ã‚»ãƒ³ã‚µãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cd /home/pi/smart-planter
python test_sensors.py

# ãƒ­ã‚°ç¢ºèª
tail -f /var/log/syslog | grep sensor

# GPIOçŠ¶æ…‹ç¢ºèª
gpio readall
```

---

## ğŸ“Š å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ¥ç¶šå®Œäº†
- [ ] I2Cãƒ»SPIæœ‰åŠ¹åŒ–å®Œäº†
- [ ] å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†
- [ ] åŸºæœ¬ã‚»ãƒ³ã‚µãƒ¼ã‚¯ãƒ©ã‚¹å®Ÿè£…å®Œäº†
- [ ] AHT25ã‚»ãƒ³ã‚µãƒ¼ã‚¯ãƒ©ã‚¹å®Ÿè£…å®Œäº†
- [ ] SEN0193ã‚»ãƒ³ã‚µãƒ¼ã‚¯ãƒ©ã‚¹å®Ÿè£…å®Œäº†
- [ ] ãƒ•ãƒ­ãƒ¼ãƒˆã‚¹ã‚¤ãƒƒãƒã‚¯ãƒ©ã‚¹å®Ÿè£…å®Œäº†
- [ ] ã‚»ãƒ³ã‚µãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¯ãƒ©ã‚¹å®Ÿè£…å®Œäº†
- [ ] ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå®Œäº†
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèªå®Œäº†
- [ ] ãƒ­ã‚°å‡ºåŠ›ç¢ºèªå®Œäº†

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **è‡ªå‹•çµ¦æ°´æ©Ÿèƒ½å®Ÿè£…**: ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãçµ¦æ°´åˆ¶å¾¡
2. **ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½**: CSVå½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
3. **LINEé€šçŸ¥çµ±åˆ**: ã‚»ãƒ³ã‚µãƒ¼ç•°å¸¸æ™‚ã®é€šçŸ¥
4. **Web UIçµ±åˆ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º

---

**ä½œæˆæ—¥**: 2025å¹´1æœˆ
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ãƒãƒ¼ãƒ **: KEBABS

